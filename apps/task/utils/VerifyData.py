"""
@Project ：iotscan 
@File    ：VerifyData.py
@IDE     ：PyCharm 
@Author  ：zhizhuo
@Date    ：2023/9/22 12:05 
"""
import json
import logging

from common.tools import common_tool
from common.device import device_tools

log = logging.getLogger("tasks-server-api")


def target_verify(target_list):
    """
    攻击目标数据格式验证
    :param target_list: 攻击目标list
    :return:list
    """
    target_ids = list()
    networks_info = device_tools.get_network_info()
    scan_ips = [ip for item in networks_info for key in ('ipv4', 'ipv6') for ip in
                (item.get(key) if isinstance(item.get(key), list) else [item.get(key)]) if item.get(key)]
    for i in list(filter(None, target_list)):
        if common_tool.is_domain_name(i):
            target_ids.append(i)
        elif common_tool.verify_ip(i.split("/")[0]) or common_tool.verify_ip((i.split("-")[0])):
            try:
                ips = common_tool.generate_ips(i)
                if common_tool.verify_ip(i):
                    ips = [i]
                if len(ips) > 0:
                    for ip in ips:
                        if ip in scan_ips:
                            log.error(f"发现扫描器出口ip：{ip}")
                        elif not common_tool.is_local_ip(ip):
                            target_ids.append(ip)
                        else:
                            log.error(f"发现内网本地ip：{ip}")
            except Exception as e:
                log.error(f"批量生成ip地址出错，错误数据：{i}，错误信息：{e}")
                raise ValueError(f"异常错误数据：{i}")
    return target_ids


if __name__ == '__main__':
    ip_test = ["121.5.97.54", "183.136.212.142", "101.226.27.223", "175.24.251.77", "40.73.245.104", "42.159.133.235",
               "139.217.189.194", "101.226.27.229", "40.73.99.117", "115.159.19.114", "10.126.144.19",
               "139.224.219.209", "216.255.67.83", "150.158.229.147", "121.4.234.183", "42.159.225.53", "106.54.99.93",
               "120.133.230.132", "172.18.6.232",
               "0.0.0.0", "42.159.251.161", "111.231.97.251", "49.234.245.35", "139.217.187.43", "52.81.5.232",
               "40.125.170.21", "124.93.0.236", "71.131.201.92", "212.129.230.184", "212.129.162.254",
               "220.196.184.167", "101.34.142.112", "116.246.14.237", "123.206.180.14", "139.219.136.64",
               "39.106.172.215", "42.192.32.39",
               "54.222.159.98", "81.69.152.80", "54.222.128.174", "42.159.243.215", "211.150.64.208", "122.152.197.187",
               "101.226.27.222", "47.101.208.128", "106.54.99.157", "111.231.70.139", "175.24.154.164", "175.24.143.41",
               "42.159.197.98", "10.72.156.118", "150.158.237.250", "106.54.143.157", "121.5.97.129", "40.126.88.64",
               "121.4.8.57", "212.64.49.78", "111.231.176.146", "42.159.132.179", "118.25.33.139", "111.231.96.27",
               "140.207.161.162", "42.192.31.178", "119.36.226.229", "23.40.8.39", "139.217.254.129", "42.159.206.44",
               "52.130.67.139", "52.130.82.176", "118.212.225.122", "139.217.239.226", "139.219.191.237",
               "81.69.183.112", "81.69.167.254", "122.112.151.59", "81.69.181.24", "150.158.220.137", "121.5.97.4",
               "49.234.9.34",
               "40.73.116.230", "81.69.154.30", "139.219.129.233", "106.14.9.130", "42.159.228.69", "54.223.123.40",
               "10.72.152.76", "39.105.81.212", "211.150.64.54", "220.196.181.120", "47.103.111.126", "54.223.178.211",
               "111.231.147.120", "150.158.224.192", "212.129.162.235", "116.246.14.194", "42.192.252.231",
               "58.215.145.105", "106.54.99.14", "216.255.64.191", "42.159.232.157", "180.101.153.98", "42.159.243.174",
               "47.102.11.179", "121.5.97.124", "103.253.207.132", "52.130.187.180", "123.207.176.224", "212.64.24.156",
               "52.130.2.32", "115.47.140.99", "52.130.89.246", "123.57.253.119", "81.69.153.129", "58.243.200.177",
               "81.69.165.71", "81.69.157.98", "120.133.230.189", "42.159.207.54", "150.158.228.185", "52.130.2.34",
               "150.158.237.14", "81.69.128.173", "114.80.187.104", "40.73.99.253", "106.15.201.255", "129.211.8.233",
               "10.72.152.4", "42.159.243.27", "118.89.75.98", "42.159.250.248", "118.89.206.231", "121.5.97.55",
               "42.192.175.118", "52.130.2.35", "112.65.253.6", "121.4.234.150", "129.211.153.217", "40.72.96.242",
               "23.60.35.160", "10.126.193.132", "123.56.208.239", "175.24.140.198", "103.253.207.189",
               "118.25.168.222", "139.224.20.71", "81.69.192.199", "42.159.241.161", "81.69.156.245", "115.159.141.139",
               "154.38.242.30",
               "81.69.167.11", "117.25.156.170", "118.89.129.48", "211.150.82.8", "42.159.180.58", "101.226.27.226",
               "154.93.38.36", "47.102.252.239", "104.100.59.27", "139.219.196.37", "47.103.68.158", "49.234.243.251",
               "118.25.249.152", "10.126.115.50", "212.64.117.78", "101.226.27.228", "139.219.185.94",
               "111.231.179.251", "211.150.82.7", "40.73.70.192", "121.4.234.169", "122.152.204.196", "101.226.27.225",
               "101.226.27.224",
               "121.5.97.188", "139.217.219.114", "118.25.249.26", "129.211.155.40", "115.159.17.176", "10.126.182.174",
               "52.130.2.33", "42.159.155.102", "42.159.232.55", "101.226.27.227", "42.192.252.206", "212.64.109.216",
               "42.159.251.114", "10.126.141.158", "40.73.109.37", "139.219.191.131", "150.158.222.157",
               "54.222.146.88", "150.158.215.173", "81.69.167.63", "129.211.54.121", "42.192.13.54", "119.36.226.210",
               "180.96.1.93",
               "118.89.99.152", "81.68.163.157", "42.159.155.48", "111.231.48.227", "210.51.170.15", "111.231.147.221",
               "23.74.145.227", "42.192.174.242", "211.159.156.105", "81.69.153.217", "40.73.5.159", "118.25.165.133",
               "139.219.134.55", "139.219.197.14", "118.25.91.15", "118.89.97.213", "212.129.233.115", "212.64.46.60",
               "40.73.91.104", "81.69.128.67", "40.73.47.97", "212.64.45.252", "118.25.32.53", "129.211.156.122",
               "220.196.181.151", "127.0.0.1", "139.219.227.0", "139.219.187.19", "139.219.195.254", "118.25.118.180",
               "119.45.68.244", "139.217.185.58", "119.36.226.234", "182.254.52.146", "211.150.65.66", "211.150.84.8",
               "122.152.213.144", "116.66.122.74", "54.223.4.5", "10.126.115.241"]
    target_verify(ip_test)
